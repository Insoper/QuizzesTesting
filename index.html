<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hasil Quiz Interaktif</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .table-responsive {
      margin-bottom: 20px;
    }
    .view-details-btn {
      transition: all 0.2s;
    }
    .view-details-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #student-details-container {
      transition: opacity 0.3s ease;
    }
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      vertical-align: text-bottom;
      border: 0.25em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
    }
    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }
    .d-none {
      display: none;
    }
    .badge-score {
      font-size: 0.9em;
      padding: 0.35em 0.65em;
    }
    .score-excellent {
      background-color: #28a745;
    }
    .score-good {
      background-color: #17a2b8;
    }
    .score-average {
      background-color: #ffc107;
      color: #212529;
    }
    .score-poor {
      background-color: #dc3545;
    }
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    .date-filter-container {
      position: relative;
    }
    .date-filter-container .form-control {
      padding-right: 2.5rem;
    }
    .date-filter-container .clear-date {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Hasil Quiz Interaktif</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="filter-category" class="form-label">Filter Kategori</label>
            <select class="form-select" id="filter-category">
              <option value="all">Semua Kategori</option>
            </select>
          </div>
          <div class="col-md-4 date-filter-container">
            <label for="filter-date" class="form-label">Filter Tanggal</label>
            <input type="date" class="form-control" id="filter-date">
            <span class="clear-date" id="clear-date-filter"><i class="fas fa-times"></i></span>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary" id="filter-results">
              <span id="filter-results-text">Terapkan Filter</span>
              <span id="filter-results-spinner" class="loading-spinner d-none"></span>
            </button>
          </div>
        </div>
        
        <!-- Tabel Ringkasan Kelas -->
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="class-summary-table">
            <thead class="table-dark">
              <tr>
                <th>Kode Kelas</th>
                <th>Kategori</th>
                <th>Tanggal</th>
                <th>Jumlah Peserta</th>
                <th>Rata-rata Nilai</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" class="text-center">Gunakan filter untuk melihat hasil</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Tabel Detail Peserta dan Grafik -->
        <div class="d-none" id="student-details-container">
          <div class="row">
            <div class="col-md-8">
              <h5 class="mb-3">
                Detail Peserta Kelas: 
                <span id="detail-class-code" class="badge bg-primary"></span>
                <small class="text-muted ms-2" id="detail-class-date"></small>
              </h5>
            </div>
            <div class="col-md-4 text-end">
              <button class="btn btn-secondary" id="back-to-summary">
                <i class="fas fa-arrow-left me-2"></i>Kembali ke Ringkasan
              </button>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="score-distribution-chart"></canvas>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="student-details-table">
              <thead class="table-dark">
                <tr>
                  <th>No</th>
                  <th>Nama Siswa</th>
                  <th>Waktu Submit</th>
                  <th>Nilai</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Konfigurasi
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxmYIGtbDeuJZBuYnzkmzzBnT7M0yoEc-tl2aHaCR677X0XChG24I8BC8YQjN2nyIW2oA/exec';
    
    // Variabel global
    let resultsData = [];
    let scoreChart = null;
    
    // Inisialisasi saat DOM siap
    document.addEventListener('DOMContentLoaded', function() {
      // Load kategori saat pertama kali
      loadCategories();
      
      // Event listener untuk tombol filter
      document.getElementById('filter-results').addEventListener('click', loadResults);
      
      // Event listener untuk tombol clear date
      document.getElementById('clear-date-filter').addEventListener('click', function() {
        document.getElementById('filter-date').value = '';
        loadResults();
      });
      
      // Event listener untuk tombol kembali
      document.getElementById('back-to-summary').addEventListener('click', function() {
        document.getElementById('student-details-container').classList.add('d-none');
        document.querySelector('#class-summary-table').closest('.table-responsive').classList.remove('d-none');
        if (scoreChart) {
          scoreChart.destroy();
          scoreChart = null;
        }
      });
    });
    
    // Fungsi untuk memuat kategori
    async function loadCategories() {
      try {
        const response = await fetch(`${WEB_APP_URL}?action=getCategories`);
        const data = await response.json();
        
        if (data.status === 'success' && data.data && data.data.length > 0) {
          const select = document.getElementById('filter-category');
          select.innerHTML = '<option value="all">Semua Kategori</option>';
          
          const uniqueCategories = [...new Set(data.data)];
          uniqueCategories.forEach(category => {
            if (category) {
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              select.appendChild(option);
            }
          });
        }
      } catch (error) {
        console.error('Gagal memuat kategori:', error);
      }
    }
    
    // Fungsi untuk memuat hasil dengan filter tanggal
    async function loadResults() {
      const category = document.getElementById('filter-category').value;
      const dateFilter = document.getElementById('filter-date').value;
      
      const filterBtn = document.getElementById('filter-results');
      const filterText = document.getElementById('filter-results-text');
      const filterSpinner = document.getElementById('filter-results-spinner');
      
      filterBtn.disabled = true;
      filterText.textContent = 'Memuat...';
      filterSpinner.classList.remove('d-none');
      
      const tbody = document.querySelector('#class-summary-table tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center"><span class="loading-spinner me-2"></span>Memuat data...</td></tr>';
      
      try {
        let url = `${WEB_APP_URL}?action=getResults`;
        if (category !== 'all') url += `&category=${encodeURIComponent(category)}`;
        if (dateFilter) {
          // Format tanggal ke YYYY-MM-DD untuk filter
          const formattedDate = new Date(dateFilter).toISOString().split('T')[0];
          url += `&date=${formattedDate}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.status === 'success') {
          resultsData = data.data;
          renderClassSummaryTable();
        } else {
          throw new Error(data.message || 'Gagal memuat hasil');
        }
      } catch (error) {
        console.error('Error:', error);
        const tbody = document.querySelector('#class-summary-table tbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">
              Gagal memuat data. Silakan coba lagi.
            </td>
          </tr>
        `;
      } finally {
        filterBtn.disabled = false;
        filterText.textContent = 'Terapkan Filter';
        filterSpinner.classList.add('d-none');
      }
    }
    
    // Fungsi untuk menampilkan ringkasan kelas
    function renderClassSummaryTable() {
      const tbody = document.querySelector('#class-summary-table tbody');
      tbody.innerHTML = '';
      
      if (!resultsData || resultsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data yang sesuai</td></tr>';
        return;
      }
      
      // Kelompokkan data berdasarkan kode kelas
      const classGroups = resultsData.reduce((acc, result) => {
        if (!acc[result.KodeKelas]) {
          acc[result.KodeKelas] = {
            KodeKelas: result.KodeKelas,
            Kategori: result.Kategori,
            Tanggal: result.Timestamp ? new Date(result.Timestamp).toLocaleDateString('id-ID') : '-',
            Peserta: [],
            TotalSkor: 0
          };
        }
        acc[result.KodeKelas].Peserta.push(result);
        acc[result.KodeKelas].TotalSkor += parseInt(result.Skor) || 0;
        return acc;
      }, {});
      
      // Tampilkan ringkasan per kelas
      Object.values(classGroups).forEach(classData => {
        const row = document.createElement('tr');
        const avgScore = (classData.TotalSkor / classData.Peserta.length).toFixed(2);
        
        row.innerHTML = `
          <td>${classData.KodeKelas || '-'}</td>
          <td>${classData.Kategori || '-'}</td>
          <td>${classData.Tanggal}</td>
          <td>${classData.Peserta.length}</td>
          <td>${avgScore}</td>
          <td>
            <button class="btn btn-sm btn-primary view-details-btn" data-class="${classData.KodeKelas}">
              <i class="fas fa-users me-1"></i> Lihat Detail
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Tambahkan event listener untuk tombol detail
      document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const classCode = this.getAttribute('data-class');
          showStudentDetails(classCode);
        });
      });
    }
    
    // Fungsi untuk menampilkan detail peserta kelas
    function showStudentDetails(classCode) {
      const classData = resultsData.filter(result => result.KodeKelas === classCode);
      const firstRecord = classData[0] || {};
      
      document.getElementById('detail-class-code').textContent = classCode;
      document.getElementById('detail-class-date').textContent = firstRecord.Timestamp 
        ? formatDate(new Date(firstRecord.Timestamp)) 
        : '';
      
      const tbody = document.querySelector('#student-details-table tbody');
      tbody.innerHTML = '';
      
      // Urutkan berdasarkan nilai tertinggi
      classData.sort((a, b) => (b.Skor || 0) - (a.Skor || 0));
      
      // Tampilkan semua data siswa
      classData.forEach((result, index) => {
        const row = document.createElement('tr');
        const timestamp = result.Timestamp ? new Date(result.Timestamp) : null;
        const score = result.Skor || 0;
        const scoreClass = getScoreClass(score);
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${result.NamaSiswa || '-'}</td>
          <td>${timestamp ? formatTime(timestamp) : '-'}</td>
          <td>${score}</td>
          <td><span class="badge badge-score ${scoreClass}">${getScoreStatus(score)}</span></td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Tampilkan detail dan sembunyikan ringkasan
      document.querySelector('#class-summary-table').closest('.table-responsive').classList.add('d-none');
      document.getElementById('student-details-container').classList.remove('d-none');
      
      // Buat/tampilkan grafik distribusi nilai
      renderScoreChart(classData);
    }
    
    // Fungsi untuk membuat grafik distribusi nilai
    function renderScoreChart(classData) {
      const ctx = document.getElementById('score-distribution-chart').getContext('2d');
      
      // Hitung distribusi nilai
      const scoreRanges = [
        { min: 0, max: 49, label: '0-49' },
        { min: 50, max: 64, label: '50-64' },
        { min: 65, max: 79, label: '65-79' },
        { min: 80, max: 89, label: '80-89' },
        { min: 90, max: 100, label: '90-100' }
      ];
      
      const distribution = scoreRanges.map(range => {
        return classData.filter(student => {
          const score = parseInt(student.Skor) || 0;
          return score >= range.min && score <= range.max;
        }).length;
      });
      
      const labels = scoreRanges.map(range => range.label);
      
      // Hancurkan chart sebelumnya jika ada
      if (scoreChart) {
        scoreChart.destroy();
      }
      
      scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Distribusi Nilai',
            data: distribution,
            backgroundColor: [
              'rgba(220, 53, 69, 0.7)',
              'rgba(255, 193, 7, 0.7)',
              'rgba(23, 162, 184, 0.7)',
              'rgba(108, 117, 125, 0.7)',
              'rgba(40, 167, 69, 0.7)'
            ],
            borderColor: [
              'rgba(220, 53, 69, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(23, 162, 184, 1)',
              'rgba(108, 117, 125, 1)',
              'rgba(40, 167, 69, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Jumlah Siswa'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Rentang Nilai'
              }
            }
          }
        }
      });
    }
    
    // Fungsi helper untuk menentukan kelas CSS berdasarkan nilai
    function getScoreClass(score) {
      score = parseInt(score) || 0;
      if (score >= 90) return 'score-excellent';
      if (score >= 80) return 'score-good';
      if (score >= 65) return 'score-average';
      return 'score-poor';
    }
    
    // Fungsi helper untuk menentukan status nilai
    function getScoreStatus(score) {
      score = parseInt(score) || 0;
      if (score >= 90) return 'Sangat Baik';
      if (score >= 80) return 'Baik';
      if (score >= 65) return 'Cukup';
      return 'Perlu Perbaikan';
    }
    
    // Fungsi format tanggal Indonesia (hari, tanggal bulan tahun)
    function formatDate(date) {
      if (!date) return '-';
      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      return date.toLocaleDateString('id-ID', options);
    }
    
    // Fungsi format waktu (HH:MM)
    function formatTime(date) {
      if (!date) return '-';
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }
  </script>
</body>
</html>
